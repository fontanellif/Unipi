 /** \file comsock.c       \author Filippo Fontanelli mat 422385     Si dichiara che il contenuto di questo file e' in ogni sua parte opera     originale dell' autore.  */#include "comsock.h"/*#define DEBUG*/int createServerChannel(char* path) {	struct sockaddr_un saddr;	int fd_skt;	/*controllo la lunghezza del pathname*/	if (strlen(path) > UNIX_PATH_MAX) {		return SNAMETOOLONG;	}	errno = 0;	/*Creo un socket per il serverChannel (in assenza di errori)*/	if ((fd_skt = socket(AF_UNIX, SOCK_STREAM , 0)) == -1) {		close(fd_skt);		return -1;	}	strncpy(saddr.sun_path, path, UNIX_PATH_MAX);	saddr.sun_family = AF_UNIX;	errno = 0;#ifdef DEBUG	printf("fd_skt = socket(AF_UNIX, SOCK_STREAM , 0) riuscita, errno : %d\n", errno);	fflush(stdout);#endif	if (bind(fd_skt, (struct sockaddr *)&saddr, sizeof(saddr)) == -1) {		close(fd_skt);		return -1;	}	errno = 0;#ifdef DEBUG	printf("bind(fd_skt, (struct sockaddr *)&saddr, sizeof(saddr)) riuscita, errno : %d\n", errno);	fflush(stdout);#endif	if (listen(fd_skt, SOMAXCONN) == -1) {		close(fd_skt);		return -1;	}	if (fd_skt <= 0)return -1;	return fd_skt;}int closeSocket(int s) {	int closerror = 0;	errno = 0;	if((closerror = close(s)) == -1) return -1;	return 0;}int acceptConnection(int s) {	int fdc;	errno = 0;	if ((fdc = accept(s, NULL, 0) )== -1) {		return -1;	}	return fdc;}int receiveMessage(int sc, message_t * msg) {	int check = 0, n = 0;	free(msg->buffer);		if((check = read(sc,&msg->type,sizeof(char))) == -1) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;	if (n == 0) return -1;		if((check = read(sc,&msg->length,sizeof(unsigned int))) == -1) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;	/*testo la lunghezza del messaggio, se zero non leggo dal buffer*/	if (msg->length == 0) {#ifdef DEBUG		printf("reciver message msg->length == 0  sc%d\n",sc);		fflush(stdout);#endif		return n;	}	msg->buffer = calloc(sizeof(char),msg->length);	if((check = read(sc,msg->buffer,(sizeof(char)*(msg->length)))) == -1) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;#ifdef DEBUG	printf(			"OK : COMSOCK : 4receiveMessage :sc%d type : %c, testo %s   n %d   check%d\n",			sc,msg->type, msg->buffer,n , check);	fflush(stdout);#endif	/*test sul numero effettivo di caratteri letti*/	if( n == (sizeof(char)+ sizeof(unsigned int) + (sizeof(char)*msg->length))) return n;	else	return -1;}int sendMessage(int sc, message_t *msg) {	int n = 0,check= 0;	if((check = write(sc,&msg->type,sizeof(char))) == -1 ) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;	if((check = write(sc,&msg->length,sizeof(unsigned int)))== -1) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;	/*Controllo la lunghezza del buffer, se zero non devo scrivere nulla sul buffer*/	if (msg->length == 0)	return n;	if((check = write(sc,msg->buffer,sizeof(char)*msg->length)) == -1) {		if (errno == EPIPE) return SEOF;		else return -1;	}	n+= check;#ifdef DEBUG	printf(			"OK : COMSOCK : sendMessage :sc%d type : %c, testo %s   n %d   check%d\n",			sc,msg->type, msg->buffer,n , check);	fflush(stdout);#endif	/*Libero la memoria allocata*/	free(msg->buffer);	/*test sul numero effettivo di caratteri scritti*/	if( n == (sizeof(char)+ sizeof(unsigned int) + (sizeof(char)*msg->length))) return n;	else	return -1;}int openConnection(char* path) {	int fd_skt;	int tentativi = 0;	struct sockaddr_un saddr;	/*controllo la lunghezza del pathname*/	if (strlen(path) > UNIX_PATH_MAX) return SNAMETOOLONG;	errno = 0;	/*Creo un socket per il serverChannel (in assenza di errori) */	if ((fd_skt = socket(AF_UNIX, SOCK_STREAM , 0)) == -1) {		close(fd_skt);		return -1;	}	strncpy(saddr.sun_path, path, UNIX_PATH_MAX);	saddr.sun_family = AF_UNIX;	errno = 0;	while (tentativi < NTRIALCONN && connect(fd_skt, (struct sockaddr*) &saddr, sizeof(saddr)) == -1) {		tentativi++;		sleep(1);	}	if ((fd_skt < 0) || tentativi == NTRIALCONN) {		close(fd_skt);		return -1;	}#ifdef DEBUG	printf("OK : comsock : openConnection(%s), socket %d\n",path,fd_skt);	fflush(stdout);#endif	return fd_skt;}